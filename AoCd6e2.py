
map = """
.........................................#...............................#..........#.......................#.....................
................#.........................................#.................................#..........#...#......................
......................#...#............#..................#......................#.##........#............#.......................
...........................#...............................##.................#..............#............#.......................
..........#....#...............#.........#.................................#.......#.....................#..........#..........#..
..........................................#..............#...............................#.......................#................
.................#..#..........#.#..................#................................#.......#.#........#....#....#...............
.......#............#....................................#..#.....##...............................#........##...........#........
......#..................................................#.....#..................#......................................#........
....................................................................................................#...#.......#.............#...
.....#...................................................#...........#...##........##.................................#...........
........................#..........................#...............#.......#............#..#..........##..............#...........
.....................#...................................#.........................#..............#......#..................#.....
.........#.#....#.....#...................................#....................................#..................................
.........#.#......#.........................#............................................#...#...................................#
.........................................#.#...............................#..............#..............................#........
#...........#...................#.....#..................#.........#...#...................#.............................##.....#.
#....#..........#............#................................#...#............##.....#....................#......................
#.................................##...#........#..............#.......#..........#....................................#.........#
..............#...#...............................................#................#........#...#.................#......#........
..............#.....................#.....#...........#............#...#.......##.........................##.#....................
....#............................................##...................#.......................................#........#..........
.................................................................................#...#............................................
....................................#...................#.........#......#.....#...#.............................#..............#.
.....#................................#................................#........................................................#.
.............................................#..........##........#.........#..........................#..........................
...............#..#...........#.......#........................#.........#.....................................................##.
...#....................#.........................#..#............................#...........#..#...#...............#............
........#.....................................#.......................................................#...#..#.........#.#......#.
...........................................#...............#............................................................#.....#...
.........................................#.....#............##......................#..............................#..............
..#...............#.............................#............................#.........#.......#..................................
..............................................................................................................#.............#....#
..................#.#.............#......................................#.......#...............#..........#.....................
........................#.#.......#..........#...#......#.........#......#.................#........#.......#............#....#.#.
..#.....................................................................#......................#...............#..................
..................................................................#......#............................#........#........#.........
......................................#.....................#..................#..............#...................................
................#..#.....................................................#....................................#..........#........
...................................#........................................#.#..#............................................##..
...............................#.........................#..........................#............................#.........#......
............................#........#..............#.............#.#........................................................#....
................#..................#.....#......................#.....................................................#...........
......................#........#............#..................#...............#...............#..................................
......................................................#..................................................#........................
................#.......#..................................................................#......................................
....................................#....#...............#........................................................................
.................................................................................................#...#.#..........................
.......#..#...........#.....#...............................................................................#..............#......
...#.................#.................^...................#.....#................................................................
...............#.............................................................................#.................................#..
............................................#.....#............................................................#.#........##......
................................#................................#.......#..#......#...................#......#..............#....
...................##...........................................................#.................................................
...........................#...................#..........#...................................#............#.............#...#....
.....#........................#...............#..#.#.......#...................................#.##...............#...#...........
...#.....................#.#.......................#..........#.............................................................#.....
.......#.........................................#.........#.............#....................##...........................#......
.......................................##...........#.................#.......................................#..................#
................................#.......#..........................#........#.#........#..........#...........#....##.............
.......#............#....#....................................#.....#...............#.............................................
..........#.................#............................................................................#.............#....#...#.
...#.......................#.................................................................................................#....
.......................#....#..........................................................................................#..........
......................................................................#...............................#............#....#.........
.....#..............................................................................#............#...........................#....
..#.............#..#.............#...#............................................................................................
....................................................#.......#.............................#....#............#...................#.
....................................................................#.#...#....................................#..........#.......
......#...#................#.........#.................##......................#........................#.........................
.............#.#...........#..........................................................................#...........................
..........#.....#........#........................................................................#.#.................#...........
..........#.##....................................#......#................#..........#..........#.......##.....#..................
.............................#................................................................##.............#....................
....................................#.................................................................................###.........
..................................#..........#...................................#......#.........................................
...............#...........#.............................................#......#...................................#.............
...............#...#...................................................#...................#............#...................#.....
........................................#......#.............#........#..........................#....#.....#..................#..
.......................#......................................................................#.......#...................#.....##
.................#.....................#............#............................#..........#......................#..............
....................#................................................................#................#......#.#..................
.#............#...............................................#..#......##.#................................##....#...............
.#.......#..........................................................................................................#.............
.................#............#...............................................................................#...................
.................................##......................................#.........................#................#.............
...................#.............................................................#................................................
...#.....#..#......#........#....#.................#..................#..#......................................#...........#...#.
.#.....................#...........................................................................#............................#.
.#............................#.........#...............................................#.........................................
....#......................#......................#....#........#.....#...................................#......................#
.......#.................#..............................#.....#......................#...............#..............#.......#.....
...#.................................................................................................#........#.....#......#......
......##...................................................................................#................................#.....
..........#................................#..................................#.................................................#.
...........#........#..............#...#..............#...................................................#......#.........#......
.......#...#....................................#..##.........................................................#...................
...........#............................................##..........#..#.#.....................................................#..
...................................#............................#..............#..#..................................#............
....#.......#...............#...........................................................................#.........................
...............#.....................................................................................................#............
................#..........................................#...............##...........................#....#..........#.........
...........................................#...................................................................................#..
.................#..........................................................................#.....#.............##..........#.....
...............#..................#................................#.......................#...#.....##...........................
.............#.......................#.......#.............#.#...#......#..............#.............................#.#..........
..........##....#..#..............................#...............................................................................
.................#......#.......#.....#..........#.............................#......................#.....#.....................
....#........#....................#.#.........#.#..........#......................................................................
...........................#.......#........#.........................#.#.................#........#...............#......#.......
#..#..................#...........#.....................................................................................#.........
......#...#.#...........#.....................................................#................#..#............#..................
................##.#...#..............#..............................#............................................................
...........................................................................................#.............................#........
.......#....#...................#..........................................................#............#............#.....#......
.............#....#..................................#....#........#.....................................#.#....#..............#.#
.#..................................................#...................#...............#.........................................
...#........#..................................#............#.#.......................................#...........................
................#.....#....................................#.#.#...........#......##................#.................#......#....
...#.......................#...........#...#...........#.#........................#..#.................##.....#...................
.............#.......................................#................#....#..#..#.....................#...#............#.........
..........#..................#............#...#..................#................................................................
.........#..........#.....................#..#................#.......................#.........#.......##..#.#....#.....#....#...
#..........................#.#...........#.#.........#............................................................................
..................#.....................#......#.##...................#................................................#..#.......
.....#....#......#..#............................##.........................................................#.....#.......#...##..
....#...#.#...##..................#..........................................................#.....#..............................
..............................#............#...........#..................................#....#............#.......#.............
....................................#.....................#............................#..............#...........................
............#............#..........#....##....................................#..#.....#..................#......................
"""

test_map = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

map_bounds = None
obstacles = set()
guard_pos = None
guard_dir = None

def load_map(map):
	for y, line in enumerate(map.strip().splitlines()):
		for x, tile in enumerate(line):
			global guard_pos, guard_dir
			if tile == '#':
				global obstacles
				obstacles.add((x, y))
			elif tile == '^':
				guard_pos = [x, y]
				guard_dir = 0
			elif tile == '>':
				guard_pos = [x, y]
				guard_dir = 1
			elif tile == 'v':
				guard_pos = [x, y]
				guard_dir = 2
			elif tile == '<':
				guard_pos = [x, y]
				guard_dir = 3
	global map_bounds
	map_bounds = (x, y)

def move(pos, dir, obstacles):
	dir_ = dir
	pos_ = pos.copy()
	while (dir_ == 0 and (pos_[0], pos_[1] - 1) in obstacles) or (dir_ == 1 and (pos_[0] + 1, pos_[1]) in obstacles) or (dir_ == 2 and (pos_[0], pos_[1] + 1) in obstacles) or (dir_ == 3 and (pos_[0] - 1, pos_[1]) in obstacles):
		if dir_ == 0:
			if (pos_[0], pos_[1] - 1) in obstacles:
				dir_ = (dir_ + 1) % 4
		elif dir_ == 1:
			if (pos_[0] + 1, pos_[1]) in obstacles:
				dir_ = (dir_ + 1) % 4
		elif dir_ == 2:
			if (pos_[0], pos_[1] + 1) in obstacles:
				dir_ = (dir_ + 1) % 4
		elif dir_ == 3:
			if (pos_[0] - 1, pos_[1]) in obstacles:
				dir_ = (dir_ + 1) % 4
		else:
			raise ValueError('Incorrect state')
		
	if dir_ == 0:
		pos_[1] -= 1
	elif dir_ == 1:
		pos_[0] += 1
	elif dir_ == 2:
		pos_[1] += 1
	elif dir_ == 3:
		pos_[0] -= 1
	else:
		raise ValueError('Incorrect state')
	
	in_bounds = 0 <= pos_[0] <= map_bounds[0] and 0 <= pos_[1] <= map_bounds[1]
	
	return pos_, dir_, in_bounds

def calc_guard_path():
	path = []
	dirs = []
	in_bounds = True
	global guard_pos, guard_dir
	orig_pos = guard_pos.copy()
	orig_dir = guard_dir
	
	while in_bounds:
		path.append(guard_pos.copy())
		dirs.append(guard_dir)
			
		guard_pos, guard_dir, in_bounds = move(guard_pos, guard_dir, obstacles)
	
	guard_pos = orig_pos
	guard_dir = orig_dir
	
	return path, dirs

def check_loop(start_pos, start_dir, directed_path, paths_to_loops = [], additional_obstacles = set()):
	
	visited = []
	pos = start_pos
	dir = start_dir
	in_bounds = True
	check_obstacles = obstacles.union(additional_obstacles)
	changed_path = []
	
	while move(pos, dir, check_obstacles)[:2] not in visited and in_bounds and (pos, dir) not in paths_to_loops:
		
		visited.append((pos.copy(), dir))

		if (pos, dir) not in directed_path or len(changed_path) > 0:
			changed_path.append((pos.copy(), dir))
		
		pos, dir, in_bounds = move(pos, dir, check_obstacles)
	
	print(f"{additional_obstacles = }, {visited = }")
	print(f"{in_bounds = }, {changed_path = }")
	
	return in_bounds, changed_path

def get_possibilities(path, directed_path):
	possibilities = []
	paths_to_loops = []
	
	for x, y in path:
		
		is_loop, changed_path = check_loop(guard_pos.copy(), guard_dir, directed_path, paths_to_loops, {(x, y)})
		if is_loop:
			possibilities.append((x, y))
			paths_to_loops.extend(changed_path)
		
		print(f"{paths_to_loops = }")
	
	return possibilities

load_map(test_map)

path, dirs = calc_guard_path()
directed_path = list(zip(path, dirs))

print(obstacles)
print(directed_path)

possibilities = get_possibilities(list(set(tuple(p) for p in path)), directed_path)

print(possibilities)
print(len(possibilities))
